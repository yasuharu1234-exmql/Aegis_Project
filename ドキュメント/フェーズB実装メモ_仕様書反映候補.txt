================================================================================
フェーズB実装メモ
仕様書反映候補事項
================================================================================

作成日: 2026-01-05
作成者: Claude（実装担当）
対象: 追従型OCO観測層・判断層の実装

================================================================================
1. CLA_Dataへの追加事項
================================================================================

1.1 メンバ変数
----------------------------------------------------------------

追加したメンバ変数:
```cpp
// ========== フェーズB追加: 追従型OCO観測データ ==========
bool m_obs_entry_clear;  // エントリー可能状態（約定前注文・ポジションなし）
```

初期化:
```cpp
m_obs_entry_clear = false;  // フェーズB: 追従型OCO観測初期化
```

1.2 アクセサメソッド
----------------------------------------------------------------

追加したメソッド:

**SetObs_EntryClear(bool is_clear)**
- 役割: エントリー可能状態を設定
- 引数: true=エントリー可能, false=障害あり
- 呼び出し元: 観測層（CObservationOCOState）

**GetObs_EntryClear()**
- 役割: エントリー可能状態を取得
- 戻り値: true=エントリー可能, false=障害あり
- 呼び出し元: 判断層（CDecisionOCOFollow）

1.3 命名規則
----------------------------------------------------------------

**提案: 観測データの命名規則を統一すべき**

現状:
- RSI値: SetRSIValue() / GetRSIValue()
- エントリー可能: SetObs_EntryClear() / GetObs_EntryClear()

→ 命名が不統一（RSI_Valueにはプレフィックスなし）

**推奨案:**
- 観測データには「Obs_」プレフィックスを統一
- 例: SetObs_RSI() / GetObs_RSI()
- 例: SetObs_EntryClear() / GetObs_EntryClear()

**ただし:**
- 既存のSetRSIValue()は変更しない（後方互換）
- 新規追加時にのみ統一規則を適用

================================================================================
2. CObservationOCOState仕様
================================================================================

2.1 クラス概要
----------------------------------------------------------------

**ファイル名:** CObservationOCOState.mqh
**レイヤー:** Observation
**目的:** 追従型OCO戦略用の状態観測

2.2 観測する事実
----------------------------------------------------------------

**1. 約定前注文の有無**
- 対象: BuyStop, SellStop
- チェック: マジックナンバー、シンボル

**2. ポジションの有無**
- 対象: Buy, Sell（約定済み）
- チェック: マジックナンバー、シンボル

**3. エントリー可能判定**
- 両方なし → true（エントリー可能）
- どちらか存在 → false（エントリー不可）

2.3 設計思想
----------------------------------------------------------------

**重要:** 判断はしない
- ○ 事実を観測してCLA_Dataに格納
- × エントリーすべきか判断（これは判断層の役割）

2.4 実装上の注意
----------------------------------------------------------------

**exMQL.OrdersTotal()の使用**
- MT4/MT5互換のため、EXMQL経由でのみアクセス
- OrderSelect()も同様

**マジックナンバーチェック**
- コンストラクタで指定されたマジックナンバーのみを対象
- 他のEA・手動注文は無視

================================================================================
3. CDecisionOCOFollow仕様
================================================================================

3.1 クラス概要
----------------------------------------------------------------

**ファイル名:** CDecisionOCOFollow.mqh
**レイヤー:** Decision
**目的:** 追従型OCO戦略の判断層（フェーズB: 最小実装）

3.2 フェーズB実装内容
----------------------------------------------------------------

**実装済み:**
- CLA_Dataから観測結果を取得
- 受信できることを確認

**未実装（フェーズC以降）:**
- エントリー可否の最終判断
- Action生成
- Decision Arbiterとの連携
- ログ出力

3.3 設計思想
----------------------------------------------------------------

**CLA_Data経由のみ**
- ○ data.GetObs_EntryClear()で取得
- × 観測層インスタンスへの直接参照

**層の分離**
- 観測層と判断層は直接参照しない
- CLA_Dataが唯一の接続点

3.4 フェーズC以降の実装予定
----------------------------------------------------------------

**Action生成:**
```cpp
// 疑似コード
if(entry_clear) {
    // OCO配置のAction生成
    // Decision Arbiterに登録
}
```

**Decision Arbiter:**
- 複数の判断ロジックを調停
- 必ず1つのActionに確定
- 実行層への橋渡し

================================================================================
4. 既存コードとの関係
================================================================================

4.1 既存実装を温存
----------------------------------------------------------------

**温存したクラス:**
- CObservationRSI（既存）
- CDecisionRSI_Simple（既存）

**理由:**
- 後方互換性維持
- 既存の観測層→判断層の直接参照方式も動作継続

4.2 新旧の共存
----------------------------------------------------------------

**観測層 → 判断層のデータ受け渡し方式:**

**旧方式（B方式）:**
```cpp
CDecisionRSI_Simple(CObservationRSI* obs) {
    m_rsi_observer = obs;
}
double rsi = m_rsi_observer->GetLastValue();
```

**新方式（A方式・フェーズB確立）:**
```cpp
// 観測層
data.SetObs_EntryClear(true);

// 判断層
bool clear = data.GetObs_EntryClear();
```

**結論:**
- 両方式が共存
- 新規実装は新方式（A方式）を採用
- 既存実装は旧方式のまま

================================================================================
5. 今後の改善候補
================================================================================

5.1 命名規則の統一
----------------------------------------------------------------

**現状の課題:**
- 観測データのアクセサが不統一
- SetRSIValue() vs SetObs_EntryClear()

**改善案:**
- 「Obs_」プレフィックスを統一
- 新規追加時のみ適用（既存は変更しない）

5.2 観測データ構造化
----------------------------------------------------------------

**現状:**
- 個別のメンバ変数で管理
- m_rsi_value, m_obs_entry_clear, ...

**将来案:**
```cpp
struct ObservationData {
    double rsi_value;
    bool entry_clear;
    // ...
};
```

**ただし:**
- フェーズBでは不要
- 複雑化を避けるため、現状維持

5.3 観測層の拡張
----------------------------------------------------------------

**フェーズC以降の拡張候補:**
- 約定前注文の詳細（価格、ロット等）
- ポジション状態の詳細（利益、損失等）
- スプレッド観測
- 経済指標観測

================================================================================
6. PMへの質問・確認事項
================================================================================

6.1 命名規則について
----------------------------------------------------------------

**質問:**
観測データのアクセサに「Obs_」プレフィックスを統一すべきか？

**現状:**
- SetRSIValue() （プレフィックスなし）
- SetObs_EntryClear() （プレフィックスあり）

**選択肢:**
- A: 新規追加時のみ「Obs_」を付ける（今回採用）
- B: 既存も含めて全て「Obs_」に統一（後方互換破壊）
- C: 統一しない（現状維持）

**推奨:**
選択肢A（後方互換維持）

6.2 フェーズBの完了条件確認
----------------------------------------------------------------

**質問:**
以下の実装でフェーズB完了と判定してよいか？

**実装内容:**
- ✅ CLA_Dataに観測結果の格納/取得を追加
- ✅ CObservationOCOState（観測層）でCLA_Dataに格納
- ✅ CDecisionOCOFollow（判断層）でCLA_Dataから取得
- ✅ コンパイルエラー/ワーニング: 0（予定）

**未実装（フェーズC以降）:**
- ❌ Action生成
- ❌ Decision Arbiter
- ❌ ログ出力

================================================================================
終
================================================================================
