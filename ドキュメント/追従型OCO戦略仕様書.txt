追従型OCO戦略仕様書 v0.2（暫定）

0. 目的
本Strategyは「市場が有効な時間帯にのみ OCO（BuyStop/SellStop）を配置し、
未約定の間は価格を更新（追従）し、片側が約定したら反対側の注文を確実に取消する」ことを目的とする。

※ 約定後の SL/TP 追従（トレイル/BE 等）は本Strategyの責務ではない。
   （別Strategyへ引き継ぐ）

1. 入力（Aegis → 追従型OCO）
- Observation層の事実（価格、スプレッド、時間帯、注文/ポジション状態など）
- Aegisが与える動作権限（Gatekeeper OK 等）
- Aegisが決定したリスク（ロット、SL/TP 等は原則 Aegis側）

2. 出力（追従型OCO → Aegis）
本Strategyの返答は必ず以下のいずれかのみ。
1) 無操作（NOOP）
2) 注文更新（OCO価格更新：PLACE or MODIFY）
3) 役割終了通知（今後このStrategyは新規OCOを出さない）

※「役割終了」は、注文約定やポジションクローズを意味しない。
※ 約定検出時に行うべきことは「反対側注文の取消」であり、これをもって役割完了とする。

3. 初期配置条件
以下をすべて満たす場合のみ初期配置する。
- Aegisが動作権限を渡している（Gatekeeper OK）
- ポジションが存在しない
- OCO注文（対象マジック/シンボル）が存在しない

4. 初期配置内容
- Buy Stop ×1 / Sell Stop ×1
- 注文距離：パラメータ（変数）から決定（#define固定は禁止）
- ロット：Aegis側で決定済み（暫定：Strategy側でも仮値可）
- SL/TP：Aegis側で決定済み（暫定：仮値可）

5. 追従（未約定OCOの価格更新）
5.1 定義
「追従」とは、未約定OCO注文の価格を現在価格（＋将来は状況）を基準に更新すること。
※ 約定後の SL/TP 更新は追従ではない。

5.2 追従条件（暫定）
- 未約定OCOが存在する
- 同一ティック内1回まで
- 既存注文より “有利方向” の場合のみ更新
  （BuyStopは下げる方向、SellStopは上げる方向 ＝ 現在価格へ近づける）

5.3 更新手段
- 原則：TRADE_ACTION_MODIFY（注文価格/SL/TPの変更）を使用
- CANCEL→再配置は行わない（例外は実装後）

6. 約定検出時の責務
- 片側の約定を検出したら、反対側の未約定注文を確実に取消する。
- 両建て（両側約定）などイレギュラー検出時は、残った注文を全取消しし、役割終了通知を返す。
  （ポジション処理は別Strategyへ引き継ぐ）

7. 完了条件（このStrategyのゴール）
- OCOを出せた
- 片側の約定を検出できた
- 反対側注文を取消できた
- 以後は「役割終了通知」を返し続ける（or 無操作）
